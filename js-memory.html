<!DOCTYPE html >
    <html>
<head>
 
</head>
<body>
<canvas id="canvas" width="1130" height="960"></canvas>
<script src="ocanvas/build/dist/latest/ocanvas.js"></script>
<script>
	
var canvas = oCanvas.create({ canvas: "#canvas", background: "#000000" });



var image_base_url = 'https://raw.githubusercontent.com/semisided1/pydoit/master/src/lists/feelings/';
var img_files = ['boss/boss.png', 'doh/doh.png', 'freezing/freezing.png', 'hot/hot.png',
     'party/party.png', 'relaxed/relaxed.png', 'scared/scared.png', 'whatever/whatever.png'
 ];

var dims = [];


function Card(pos, r,i,f) {
this.position = pos;
this.mrect = r;
this.image = i;
this.flipped = f;
this.matched = false;
} 

var cards = [];
for (var i = 0, l = 8; i < l; i++) {
 dims[i] =  { center:75 + ( 130  * i ), top:50 };
 dims[i+8] = { center:75 + (130 * i), top:270 };
}    

function n_cards_flipped() {
    var toret = 0;
     for(var i=0; i<cards.length; i++) {
            if (cards[i].flipped == true) toret++;
        }
    return toret;
}

function n_cards_matched() {
    var toret = 0;
     for(var i=0; i<cards.length; i++) {
            if (cards[i].matched == true) toret++;
        }
    return toret;
}

function get_unmatched_flipped() {
    var atoret = [];
    for (var i=0; i<cards.length; i++) {
            if (cards[i].matched == false && cards[i].flipped == true ) atoret.push(cards[i]);
    }
    return atoret;
}

function image_clicked(obj_this) {
    console.log("image clicked " + obj_this.x);
    var c = getCardfromImg(obj_this);
    c.flipped = false;
      
    obj_this.animate({width: 1}, { // i want to do zero here
                                    // but there is some kind of issue, the
                                    // center mode is shifting on the base
                                    // image
		duration: "short",
		easing: "ease-in-out-cubic",
		callback: function () {
		//	this.fill = "#f00";
		    c.image.height = 1; c.image.opacity = 0; // groan
			c.mrect.animate({width: 120}, {
	    duration:"short",
	    easing: "ease-in-out-cubic",
		callback: function () {
		//	this.fill = "#f00";
			canvas.redraw();
		}
	});
			canvas.redraw();
		}
	});

}
// this is a test
function rect_clicked(obj_this) {
    console.log("rect clicked " + obj_this.x);
    var c = getCardfromRect(obj_this);
    c.flipped = true;
     
    obj_this.animate( {width: 0}, {
		duration: "short",
		easing: "ease-in-out-cubic",
		callback: function () {
/*		    c.image.width = 0;
	        c.image.animate({width: 120}, {
		        duration: "short",
		        easing: "ease-in-out-cubic"
	        });
*/			//canvas.redraw();
	c.image.x = c.mrect.x;
	c.image.y = c.mrect.y;
	c.image.width = 1;
	c.image.height = c.mrect.height;
	c.image.opacity = 1;
	
   c.image.animate( {width: 120}, {
		duration: "short",
		easing: "ease-in-out-cubic",
		callback: function (c) {
/*		    c.image.width = 0;
	        c.image.animate({width: 120}, {
		        duration: "short",
		        easing: "ease-in-out-cubic"
	        });
*/			//canvas.redraw();
		}
	});
		}
	});
	

      
    var af = get_unmatched_flipped();
	if (af.length == 2 ) {
	    if ( af[0].image.image == af[1].image.image) {
	        af[0].matched = true;
	        af[1].matched = true;
	    } else {
            // wait
            af[0].flipped = false;
            af[1].flipped = false;
        }
    }
}

for (var i = 0, l = 16; i < l; i++) {
    var rectangle = canvas.display.rectangle({
        position: i,
        x: dims[i].center,
        y: dims[i].top,
        width: 120,
        height: 170,
        fill: "#00ccaa",
        origin: { x: "center", y: "top" }
    });
    
    rectangle.bind("click tap", function() { rect_clicked(this); } );
    canvas.addChild(rectangle);
    
    var the_index = Math.floor(i/2);
    var ifile = image_base_url + img_files[the_index];
  
    var image_to_add = canvas.display.image({
    	x:1,
    	y: 1,
    	width : 10,
    	height: 10,
    	opacity: 0,
    	origin: { x: "center", y: "top" },
    	image: ifile,
    });
    
   canvas.addChild(image_to_add);
   
   image_to_add.bind("click tap", function() { image_clicked(this); } );
  
   cards.push( new Card(i,rectangle,image_to_add,false));

}
/*
    canvas.setLoop(function() {
        
        cards.forEach(function(object, index) {
            if (object.flipped == true) {
                object.image.zIndex = 1;
                object.rect.zIndex = 2;
            } else {
                object.image.zIndex = 2;
                object.rect.zIndex = 1;
            }
        });
    }).start();
*/
   function getCardfromRect(robj) {
        for(var i=0; i<cards.length; i++) {
            if (cards[i].mrect.x == robj.x && cards[i].mrect.y == robj.y ) return cards[i];
        }
        return null;
    }
    
    function getCardfromImg(iobj) {
        for(var i=0; i<cards.length; i++) {
            
            if (cards[i].image.x == iobj.x && cards[i].image.y == iobj.y) return cards[i];
        }
        return null;
    } 


</script>


</body>
</html>
