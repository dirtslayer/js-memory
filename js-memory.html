<!DOCTYPE html >
    <html>
<head>
 
</head>
<body>
<canvas id="canvas" width="1130" height="960"></canvas>
<script src="js/ocanvas-2.8.1.js"></script>
<script>
	
var canvas = oCanvas.create({ canvas: "#canvas", background: "#000000" });



var image_base_url = 'https://raw.githubusercontent.com/semisided1/pydoit/master/src/lists/feelings/';
var img_files = ['boss/boss.png', 'doh/doh.png', 'freezing/freezing.png', 'hot/hot.png',
     'party/party.png', 'relaxed/relaxed.png', 'scared/scared.png', 'whatever/whatever.png'
 ];

var dims = [];


function Card(pos, r,i,f) {
this.position = pos;
this.rect = r;
this.image = i;
this.flipped = f;
this.matched = false;
} 

var cards = [];
for (var i = 0, l = 8; i < l; i++) {
 dims[i] =  { center:75 + ( 120  * i ), top:50 };
 dims[i+8] = { center:75 + (120 * i), top:220 };
}    

function n_cards_flipped() {
    var toret = 0;
     for(var i=0; i<cards.length; i++) {
            if (cards[i].flipped == true) toret++;
        }
    return toret;
}

function n_cards_matched() {
    var toret = 0;
     for(var i=0; i<cards.length; i++) {
            if (cards[i].matched == true) toret++;
        }
    return toret;
}

function get_unmatched_flipped() {
    var atoret = [];
    for (var i=0; i<cards.length; i++) {
            if (cards[i].matched == false && cards[i].flipped == true ) atoret.push(cards[i]);
    }
    return atoret;
}

for (var i = 0, l = 16; i < l; i++) {
    var rectangle = canvas.display.rectangle({
        position: i,
        x: dims[i],
        y: mytop,
        width: 120,
        height: 170,
        fill: "#00ccaa",
        	origin: { x: "center", y: "top" }
        
    });
    
    rectangle.bind("click tap", function () {
        var c = getCardfromRect(this);
        c.flipped = true;
      
      	this.animate({
		    width: 0
	}, {
		duration: "short",
		easing: "ease-in-out-cubic",
		callback: function () {
			this.remove();
			c.image.width = 0;
	       
	        c.image.animate({
		    width: 120
	}, {
		duration: "short",
		easing: "ease-in-out-cubic"
	}
		
		);
			canvas.redraw();
		}
	});
      
      
      
        
	  
	    var af = get_unmatched_flipped();
	    
	    console.log("unmatched flipped length:" + af.length);
	    
	    if (af.length == 2 ) {
	        if ( af[0].image.image == af[1].image.image) {
	            af[0].matched = true;
	            af[1].matched = true;
	        } else {
	            // wait
	            af[0].flipped = false;
	            af[1].flipped = false;
	            af[0].image.remove();
	            canvas.addChild(af[0].rect);
	            canvas.addChild(af[1].rect);
	        }
	    }
	    
	    
    });
    
    canvas.addChild(rectangle);
    
    var the_index = Math.floor(i/2);
    var ifile = image_base_url + img_files[the_index];
  
    var image_to_add = canvas.display.image({
        
    	x: left,
    	y: mytop,
    	width : 120,
    	height: 170,
    	origin: { x: "center", y: "top" },
    	image: ifile,
    	
    });
    
   canvas.addChild(image_to_add);
   
   image_to_add.animate({
		width: 0
	}, {
		duration: 0,
		easing: "ease-in-out-cubic",
		callback: function () {
		//	this.fill = "#f00";
			canvas.redraw();
		}
	});
   
   image_to_add.bind("click tap", function() {
       // notify card to flip??
      // this.remove(true);
      var c = getCardfromImg(this);
      
        c.flipped = false;
       
       this.animate({
		width: 0
	}, {
		duration: 0,
		easing: "ease-in-out-cubic",
		callback: function () {
		//	this.fill = "#f00";
			canvas.redraw();
		}
	});
   });
   
   cards.push( new Card(rectangle,image_to_add,false));

}
/*
    canvas.setLoop(function() {
        
        cards.forEach(function(object, index) {
            if (object.flipped == true) {
                object.image.zIndex = 1;
                object.rect.zIndex = 2;
            } else {
                object.image.zIndex = 2;
                object.rect.zIndex = 1;
            }
        });
    }).start();
*/
   function getCardfromRect(robj) {
        for(var i=0; i<cards.length; i++) {
            if (cards[i].rect == robj) return cards[i];
        }
        return null;
    }
    
    function getCardfromImg(iobj) {
        for(var i=0; i<cards.length; i++) {
            if (cards[i].image == iobj) return cards[i];
        }
        return null;
    } 


</script>


</body>
</html>
